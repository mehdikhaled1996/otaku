<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاحص عبارات Mnemonic (BTC/ETH)</title>
    <!-- External Libraries from Public CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/bip39.min.js"></script> <!-- BIP39 checksum & seed derivation -->
    <script src="https://cdn.jsdelivr.net/npm/hdkey@1.1.1/dist/hdkey.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethereumjs-util@7.1.3/dist/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs.min.js"></script>
    <style>
        /* Hacker-style CSS theme */
        body {
            background-color: #000;
            color: #33ff33;
            font-family: 'Source Code Pro', monospace;
            text-shadow: 0 0 8px rgba(51, 255, 51, 0.7);
            display: flex; flex-direction: column; align-items: center;
            padding: 20px; margin: 0; min-height: 100vh; box-sizing: border-box;
        }
        h2 {
            margin-bottom: 20px; text-align: center;
        }
        input[type="file"], button {
            background: #111; color: #33ff33; border: 2px solid #33ff33;
            padding: 10px; margin: 8px 0; border-radius: 5px;
            font-family: monospace; font-size: 1em; width: 100%; max-width: 500px;
            box-shadow: 0 0 5px rgba(51,255,51,0.5); cursor: pointer;
            transition: background .3s, box-shadow .3s;
        }
        button:hover { background: #222; box-shadow: 0 0 15px rgba(51,255,51,0.9); }
        #summary { margin-top:20px; font-size:1.1em; text-align:center; max-width:600px; }
        #summary .count { color:#00ff00; font-weight:bold; }
        #results {
            background:#111; border:2px solid #33ff33; border-radius:8px;
            padding:15px; margin-top:20px; width:90%; max-width:800px;
            height:400px; overflow-y:scroll; font-family:monospace; font-size:.9em;
            box-shadow:0 0 10px rgba(51,255,51,0.6); white-space:pre-wrap; word-wrap:break-word;
        }
        #results div { padding:5px 0; border-bottom:1px dashed #222; }
        #results div:last-child { border-bottom:none; }
        .good { color:#00ff00; }
        .bad { color:#ff3333; }
        .limit{ color:#ffff33; font-weight:bold; }
        @media(max-width:600px){
            body{padding:10px;}
            #results{height:300px;font-size:.8em;padding:10px;}
        }
    </style>
</head>
<body>
    <h2>فاحص عبارات Mnemonic (BTC/ETH)</h2>
    <input type="file" id="fileInput" accept=".txt">
    <button onclick="scanFile()">بدء الفحص</button>
    <div id="summary">لم يتم الفحص بعد.</div>
    <div id="results"></div>

    <script>
        // 1) Safe fetch with CORS proxy and rate-limit detection
        const CORS_PROXY = 'https://corsproxy.io/?';
        async function safeFetch(url) {
            try {
                const res = await fetch(CORS_PROXY + encodeURIComponent(url));
                if (res.status === 429) throw new Error('rate_limit');
                if (!res.ok) return null;
                return await res.json();
            } catch (e) {
                if (e.message === 'rate_limit') throw e;
                return null;
            }
        }

        // 2) Checkers for BTC and ETH
        async function checkBtc(addr) {
            const data = await safeFetch(`https://blockstream.info/api/address/${addr}`);
            if (!data) return 0;
            const sat = data.chain_stats.funded_txo_sum - data.chain_stats.spent_txo_sum;
            return sat/1e8;
        }
        async function checkEth(addr) {
            const data = await safeFetch(`https://api.etherscan.io/api?module=account&action=balance&address=${addr}&tag=latest`);
            if (!data || !data.result) return 0;
            return parseInt(data.result,10)/1e18;
        }

        // 3) Address derivation
        function deriveBtc(seed) {
            const root = hdkey.fromMasterSeed(seed);
            const child = root.derive("m/44'/0'/0'/0/0");
            return bitcoin.payments.p2pkh({ pubkey: child.publicKey }).address;
        }
        function deriveEth(seed) {
            const root = hdkey.fromMasterSeed(seed);
            const child = root.derive("m/44'/60'/0'/0/0");
            return '0x'+ethereumjs.Util.pubToAddress(child.publicKey,true).toString('hex');
        }

        // 4) Scan single phrase
        async function scanPhrase(phrase) {
            if (!bip39.validateMnemonic(phrase)) return {ok:false};
            const seed = await bip39.mnemonicToSeed(phrase);
            const btcAddr = deriveBtc(seed);
            const ethAddr = deriveEth(seed);
            // Check balances
            const btcBal = await checkBtc(btcAddr);
            if (btcBal>0) return {ok:true,chain:'BTC',addr:btcAddr,balance:btcBal+' BTC'};
            const ethBal = await checkEth(ethAddr);
            if (ethBal>0) return {ok:true,chain:'ETH',addr:ethAddr,balance:ethBal+' ETH'};
            return {ok:false};
        }

        // 5) Batch scan with UI updates
        async function scanFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                document.getElementById('summary').innerHTML = '<span class="bad">يرجى رفع ملف العبارات أولاً.</span>';
                return;
            }
            const text = await file.text();
            const lines = text.trim().split(/\r?\n/).filter(l=>l.trim());
            const total = lines.length;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            let found=0,notfound=0,stopped=false;
            for (let i=0;i<total && !stopped;i++){
                document.getElementById('summary').innerHTML = `🚀 تم فحص <span class="count">${i+1}/${total}</span> عبارة`;
                try {
                    const res = await scanPhrase(lines[i]);
                    if (res.ok) {
                        found++;
                        resultsDiv.innerHTML += `<div class="good">✅ [${res.chain}] ${lines[i]} → ${res.addr} (${res.balance})</div>`;
                    } else {
                        notfound++;
                        resultsDiv.innerHTML += `<div class="bad">❌ ${lines[i]}</div>`;
                    }
                } catch(e) {
                    if (e.message==='rate_limit') {
                        stopped=true;
                        resultsDiv.innerHTML += `<div class="limit">⚠️ تم الوصول للحد الأقصى لطلبات API، توقف الفحص.</div>`;
                    } else {
                        notfound++;
                        resultsDiv.innerHTML += `<div class="bad">❌ ${lines[i]} (خطأ)</div>`;
                    }
                }
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
                // slight delay to keep UI responsive
                await new Promise(r=>setTimeout(r,100));
            }
            document.getElementById('summary').innerHTML = `<br>
                <span class="good">عبارات صالحة: ${found}</span> |
                <span class="bad">عبارات غير صالحة: ${notfound}</span>`;
            if (stopped) {
                document.getElementById('summary').innerHTML += `<br><span class="limit">توقف الفحص بسبب تجاوز الحد.</span>`;
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>فاحص عبارات Mnemonic (BTC/ETH)</title>

  <!-- 1) تحميل مكتبة BIP39 المضمّنة للمتصفح -->
  <script src="https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/bip39.min.js"></script>
  <!-- 2) مكتبات HDKey و EthereumJS-Util و BitcoinJS-Lib -->
  <script src="https://cdn.jsdelivr.net/npm/hdkey@1.1.1/dist/hdkey.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethereumjs-util@7.1.3/dist/index.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bitcoinjs-lib@6.1.0/dist/bitcoinjs.min.js"></script>

  <style>
    body {
      background: #000;
      color: #33ff33;
      font-family: monospace;
      padding: 1rem;
    }
    input, button {
      width: 100%;
      max-width: 500px;
      padding: .5rem;
      margin: .5rem 0;
      background: #111;
      color: #33ff33;
      border: 1px solid #33ff33;
      cursor: pointer;
    }
    button:hover {
      background: #222;
    }
    #summary {
      margin-top: 1rem;
      font-weight: bold;
    }
    #results {
      background: #111;
      padding: .5rem;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1rem;
    }
    #results div {
      padding: 4px 0;
      border-bottom: 1px dashed #222;
    }
    #results div:last-child {
      border-bottom: none;
    }
    .good { color: #00ff00; }
    .bad { color: #ff3333; }
    .limit{ color: #ffff33; font-weight: bold; }
  </style>
</head>
<body>
  <h2>فاحص عبارات Mnemonic (BTC/ETH)</h2>
  <input type="file" id="fileInput" accept=".txt">
  <button onclick="scanFile()">بدء الفحص</button>
  <div id="summary">لم يتم الفحص بعد.</div>
  <div id="results"></div>

  <script>
    const CORS_PROXY = 'https://corsproxy.io/?';

    async function safeFetchJson(url) {
      try {
        const res = await fetch(CORS_PROXY + encodeURIComponent(url));
        if (res.status === 429) throw new Error('rate_limit');
        if (!res.ok) return null;
        return await res.json();
      } catch (e) {
        if (e.message === 'rate_limit') throw e;
        return null;
      }
    }

    async function checkBtc(addr) {
      const j = await safeFetchJson(`https://blockstream.info/api/address/${addr}`);
      if (!j || !j.chain_stats) return 0;
      return (j.chain_stats.funded_txo_sum - j.chain_stats.spent_txo_sum) / 1e8;
    }

    async function checkEth(addr) {
      const j = await safeFetchJson(
        `https://api.etherscan.io/api?module=account&action=balance&address=${addr}&tag=latest`
      );
      if (!j || !j.result) return 0;
      return parseInt(j.result, 10) / 1e18;
    }

    function deriveBtc(seed) {
      const root = hdkey.fromMasterSeed(seed);
      const child = root.derive("m/44'/0'/0'/0/0");
      return bitcoinjs.payments.p2pkh({ pubkey: child.publicKey }).address;
    }

    function deriveEth(seed) {
      const root = hdkey.fromMasterSeed(seed);
      const child = root.derive("m/44'/60'/0'/0/0");
      return '0x' + ethereumjs.Util.pubToAddress(child.publicKey, true).toString('hex');
    }

    async function scanPhrase(phrase) {
      if (!bip39.validateMnemonic(phrase)) return { ok: false };
      const seed = await bip39.mnemonicToSeed(phrase);
      const btcAddr = deriveBtc(seed);
      const ethAddr = deriveEth(seed);

      const btcBal = await checkBtc(btcAddr);
      if (btcBal > 0) {
        return { ok: true, chain: 'BTC', addr: btcAddr, balance: btcBal + ' BTC' };
      }

      const ethBal = await checkEth(ethAddr);
      if (ethBal > 0) {
        return { ok: true, chain: 'ETH', addr: ethAddr, balance: ethBal + ' ETH' };
      }

      return { ok: false };
    }

    async function scanFile() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        document.getElementById('summary').textContent = '❌ يرجى رفع ملف العبارات أولاً.';
        return;
      }

      const text = await file.text();
      const lines = text.trim().split(/\r?\n/).filter(l => l.trim());
      const total = lines.length;
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      let found = 0, notfound = 0, stopped = false;

      for (let i = 0; i < total && !stopped; i++) {
        document.getElementById('summary').innerHTML =
          `🚀 تم فحص <b>${i + 1}/${total}</b> عبارة`;

        try {
          const res = await scanPhrase(lines[i]);
          if (res.ok) {
            found++;
            resultsDiv.innerHTML +=
              `<div class="good">✅ [${res.chain}] ${lines[i]} → ${res.addr} (${res.balance})</div>`;
          } else {
            notfound++;
            resultsDiv.innerHTML += `<div class="bad">❌ ${lines[i]}</div>`;
          }
        } catch (e) {
          if (e.message === 'rate_limit') {
            stopped = true;
            resultsDiv.innerHTML +=
              `<div class="limit">⚠️ تم الوصول للحد الأقصى لطلبات API، توقف الفحص.</div>`;
          } else {
            notfound++;
            resultsDiv.innerHTML +=
              `<div class="bad">❌ ${lines[i]} (خطأ: ${e.message})</div>`;
          }
        }

        resultsDiv.scrollTop = resultsDiv.scrollHeight;
        await new Promise(r => setTimeout(r, 100));
      }

      let summary = `✅ صالحة: ${found} | ❌ غير صالحة: ${notfound}`;
      if (stopped) summary += ' | ⚠️ توقف بسبب تجاوز الحد.';
      document.getElementById('summary').innerHTML = summary;
    }
  </script>
</body>
</html>
